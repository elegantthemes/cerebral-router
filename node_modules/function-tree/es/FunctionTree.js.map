{"version":3,"sources":["../src/FunctionTree.js"],"names":["EventEmitter","executeTree","createStaticTree","resolveProvider","Path","Provider","Primitive","FunctionTreeExecutionError","isPromise","createUniqueId","Date","now","Math","floor","random","isValidResult","result","Array","isArray","createErrorObject","error","execution","functionDetails","payload","errorToReturn","Object","assign","_execution","id","functionIndex","toJSON","name","message","stack","FunctionTreeExecution","staticTree","functionTree","errorCallback","datetime","hasThrown","isAsync","runFunction","bind","funcDetails","prevPayload","next","context","createContext","emit","function","then","outputs","Error","JSON","stringify","keys","catch","contextProviders","newContext","props","path","reduce","output","outputPath","debuggerProvider","debugger","get","currentContext","provider","wrap","getWrapped","FunctionTree","options","cachedTrees","cachedStaticTrees","executeBranchWrapper","cb","providerKeys","indexOf","resolve","run","tree","args","slice","call","arguments","forEach","arg","withResolveAndReject","reject","treeIdx","push","finalPayload","currentPayload","functionsToResolve","functionsResolved","Promise"],"mappings":"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","file":"FunctionTree.js","sourcesContent":["import EventEmitter from 'eventemitter3'\nimport executeTree from './executeTree'\nimport createStaticTree from './staticTree'\nimport resolveProvider from './providers/Resolve'\nimport Path from './Path'\nimport Provider from './Provider'\nimport { Primitive } from './primitives'\nimport { FunctionTreeExecutionError } from './errors'\nimport { isPromise } from './utils'\n\n/*\n  Need to create a unique ID for each execution to identify it\n  in debugger\n*/\nfunction createUniqueId() {\n  return Date.now() + '_' + Math.floor(Math.random() * 10000)\n}\n\n/*\n  Validate any returned value from a function. Has\n  to be nothing or an object\n*/\nfunction isValidResult(result) {\n  return !result || (typeof result === 'object' && !Array.isArray(result))\n}\n\n/*\n  Create an error with execution details\n*/\nfunction createErrorObject(error, execution, functionDetails, payload) {\n  const errorToReturn = error\n\n  errorToReturn.execution = execution\n  errorToReturn.functionDetails = functionDetails\n  errorToReturn.payload = Object.assign({}, payload, {\n    _execution: {\n      id: execution.id,\n      functionIndex: functionDetails.functionIndex,\n    },\n    error: error.toJSON\n      ? error.toJSON()\n      : {\n          name: error.name,\n          message: error.message,\n          stack: error.stack,\n        },\n  })\n\n  return errorToReturn\n}\n\nclass FunctionTreeExecution {\n  constructor(name, staticTree, functionTree, errorCallback) {\n    this.id = createUniqueId()\n    this.name = name || staticTree.name || this.id\n    this.staticTree = staticTree\n    this.functionTree = functionTree\n    this.datetime = Date.now()\n    this.errorCallback = errorCallback\n    this.hasThrown = false\n    this.isAsync = false\n\n    this.runFunction = this.runFunction.bind(this)\n  }\n\n  /*\n    Creates the context for the current function to be run,\n    emits events and handles its returned value. Also handles\n    the returned value being a promise\n  */\n  runFunction(funcDetails, payload, prevPayload, next) {\n    if (this.hasThrown) {\n      return\n    }\n\n    const context = this.createContext(funcDetails, payload, prevPayload)\n    const functionTree = this.functionTree\n    const errorCallback = this.errorCallback\n    const execution = this\n    let result\n\n    functionTree.emit('functionStart', execution, funcDetails, payload)\n    try {\n      result = funcDetails.function(context)\n    } catch (error) {\n      this.hasThrown = true\n\n      return errorCallback(\n        createErrorObject(error, execution, funcDetails, payload),\n        execution,\n        funcDetails,\n        payload\n      )\n    }\n\n    /*\n      If result is a promise we want to emit an event and wait for it to resolve to\n      move on\n    */\n    if (isPromise(result)) {\n      functionTree.emit(\n        'asyncFunction',\n        execution,\n        funcDetails,\n        payload,\n        result\n      )\n      this.isAsync = true\n      result\n        .then(function(result) {\n          if (result instanceof Path) {\n            functionTree.emit(\n              'functionEnd',\n              execution,\n              funcDetails,\n              payload,\n              result\n            )\n            next(result.toJSON())\n          } else if (funcDetails.outputs) {\n            functionTree.emit(\n              'functionEnd',\n              execution,\n              funcDetails,\n              payload,\n              result\n            )\n            throw new FunctionTreeExecutionError(\n              execution,\n              funcDetails,\n              payload,\n              new Error(\n                'The result ' +\n                  JSON.stringify(result) +\n                  ' from function ' +\n                  funcDetails.name +\n                  ' needs to be a path of either ' +\n                  Object.keys(funcDetails.outputs)\n              )\n            )\n          } else if (isValidResult(result)) {\n            functionTree.emit(\n              'functionEnd',\n              execution,\n              funcDetails,\n              payload,\n              result\n            )\n            next({\n              payload: result,\n            })\n          } else {\n            functionTree.emit(\n              'functionEnd',\n              execution,\n              funcDetails,\n              payload,\n              result\n            )\n            throw new FunctionTreeExecutionError(\n              execution,\n              funcDetails,\n              payload,\n              new Error(\n                'The result ' +\n                  JSON.stringify(result) +\n                  ' from function ' +\n                  funcDetails.name +\n                  ' is not a valid result'\n              )\n            )\n          }\n        })\n        .catch(function(result) {\n          if (execution.hasThrown) {\n            return\n          }\n\n          if (result instanceof Error) {\n            execution.hasThrown = true\n            errorCallback(\n              createErrorObject(result, execution, funcDetails, payload),\n              execution,\n              funcDetails,\n              payload\n            )\n          } else if (result instanceof Path) {\n            functionTree.emit(\n              'functionEnd',\n              execution,\n              funcDetails,\n              payload,\n              result\n            )\n            next(result.toJSON())\n          } else if (funcDetails.outputs) {\n            let error = new FunctionTreeExecutionError(\n              execution,\n              funcDetails,\n              payload,\n              new Error(\n                'The result ' +\n                  JSON.stringify(result) +\n                  ' from function ' +\n                  funcDetails.name +\n                  ' needs to be a path of either ' +\n                  Object.keys(funcDetails.outputs)\n              )\n            )\n\n            execution.hasThrown = true\n            errorCallback(\n              createErrorObject(error, execution, funcDetails, payload),\n              execution,\n              funcDetails,\n              payload\n            )\n          } else if (isValidResult(result)) {\n            functionTree.emit(\n              'functionEnd',\n              execution,\n              funcDetails,\n              payload,\n              result\n            )\n            next({\n              payload: result,\n            })\n          } else {\n            let error = new FunctionTreeExecutionError(\n              execution,\n              funcDetails,\n              payload,\n              new Error(\n                'The result ' +\n                  JSON.stringify(result) +\n                  ' from function ' +\n                  funcDetails.name +\n                  ' is not a valid result'\n              )\n            )\n            execution.hasThrown = true\n\n            errorCallback(\n              createErrorObject(error, execution, funcDetails, payload),\n              execution,\n              funcDetails,\n              payload\n            )\n          }\n        })\n    } else if (result instanceof Path) {\n      functionTree.emit('functionEnd', execution, funcDetails, payload, result)\n      next(result.toJSON())\n    } else if (funcDetails.outputs) {\n      let error = new FunctionTreeExecutionError(\n        execution,\n        funcDetails,\n        payload,\n        new Error(\n          'The result ' +\n            JSON.stringify(result) +\n            ' from function ' +\n            funcDetails.name +\n            ' needs to be a path of either ' +\n            Object.keys(funcDetails.outputs)\n        )\n      )\n\n      this.hasThrown = true\n      errorCallback(\n        createErrorObject(error, execution, funcDetails, payload),\n        execution,\n        funcDetails,\n        payload\n      )\n    } else if (isValidResult(result)) {\n      functionTree.emit('functionEnd', execution, funcDetails, payload, result)\n      next({\n        payload: result,\n      })\n    } else {\n      let error = new FunctionTreeExecutionError(\n        execution,\n        funcDetails,\n        payload,\n        new Error(\n          'The result ' +\n            JSON.stringify(result) +\n            ' from function ' +\n            funcDetails.name +\n            ' is not a valid result'\n        )\n      )\n      this.hasThrown = true\n\n      errorCallback(\n        createErrorObject(error, execution, funcDetails, payload),\n        execution,\n        funcDetails,\n        payload\n      )\n    }\n  }\n\n  /*\n    Creates the context for the next running function\n  */\n  createContext(functionDetails, payload, prevPayload) {\n    const contextProviders = this.functionTree.contextProviders\n    const newContext = {\n      execution: this,\n      props: payload || {},\n      functionDetails,\n      path: functionDetails.outputs\n        ? Object.keys(functionDetails.outputs).reduce((output, outputPath) => {\n            output[outputPath] = (payload) => new Path(outputPath, payload)\n\n            return output\n          }, {})\n        : null,\n    }\n\n    const debuggerProvider =\n      contextProviders.debugger &&\n      contextProviders.debugger.get(\n        newContext,\n        functionDetails,\n        payload,\n        prevPayload\n      )\n\n    const context = Object.keys(contextProviders).reduce(\n      (currentContext, name) => {\n        const provider = contextProviders[name]\n\n        if (provider instanceof Provider) {\n          currentContext[name] = provider.get(\n            currentContext,\n            functionDetails,\n            payload,\n            prevPayload\n          )\n        } else {\n          currentContext[name] = provider\n        }\n\n        return currentContext\n      },\n      newContext\n    )\n\n    if (debuggerProvider) {\n      return Object.keys(context).reduce((currentContext, name) => {\n        const provider = contextProviders[name]\n\n        if (provider && provider instanceof Provider && provider.wrap) {\n          currentContext[name] =\n            typeof provider.wrap === 'function'\n              ? provider.wrap(context, functionDetails)\n              : provider.getWrapped(name, context)\n        } else {\n          currentContext[name] = context[name]\n        }\n\n        return currentContext\n      }, {})\n    }\n\n    return context\n  }\n}\n\nexport class FunctionTree extends EventEmitter {\n  constructor(contextProviders = {}, options = {}) {\n    super()\n    this.cachedTrees = []\n    this.cachedStaticTrees = []\n    this.executeBranchWrapper =\n      options.executeBranchWrapper ||\n      function(cb) {\n        cb()\n      }\n\n    if (\n      typeof contextProviders !== 'object' ||\n      contextProviders === null ||\n      Array.isArray(contextProviders)\n    ) {\n      throw new Error(\n        'You have to pass an object of context providers to FunctionTree'\n      )\n    }\n\n    const providerKeys = Object.keys(contextProviders)\n\n    if (\n      providerKeys.indexOf('props') >= 0 ||\n      providerKeys.indexOf('path') >= 0 ||\n      providerKeys.indexOf('resolve') >= 0 ||\n      providerKeys.indexOf('execution') >= 0 ||\n      providerKeys.indexOf('debugger') >= 0\n    ) {\n      throw new Error(\n        'You are trying to add a provider with protected key. \"props\", \"path\", \"resolve\", \"execution\" and \"debugger\" are protected'\n      )\n    }\n\n    this.contextProviders = Object.assign({}, contextProviders, {\n      resolve: resolveProvider,\n    })\n\n    this.run = this.run.bind(this)\n  }\n\n  /*\n    Analyses the tree to identify paths and its validity. This analysis\n    is cached. Then the method creates an execution for the tree to run.\n  */\n  run() {\n    let name\n    let tree\n    let payload\n    let cb\n    let staticTree\n    const args = [].slice.call(arguments)\n    args.forEach((arg) => {\n      if (typeof arg === 'string') {\n        name = arg\n      } else if (Array.isArray(arg) || arg instanceof Primitive) {\n        tree = arg\n      } else if (!tree && typeof arg === 'function') {\n        tree = arg\n      } else if (typeof arg === 'function') {\n        cb = arg\n      } else {\n        payload = arg\n      }\n    })\n\n    if (!tree) {\n      throw new Error('function-tree - You did not pass in a function tree')\n    }\n\n    const withResolveAndReject = (resolve, reject) => {\n      const treeIdx = this.cachedTrees.indexOf(tree)\n      if (treeIdx === -1) {\n        staticTree = createStaticTree(name, tree)\n        this.cachedTrees.push(tree)\n        this.cachedStaticTrees.push(staticTree)\n      } else {\n        staticTree = this.cachedStaticTrees[treeIdx]\n      }\n      const execution = new FunctionTreeExecution(\n        name,\n        staticTree,\n        this,\n        (error, execution, funcDetails, finalPayload) => {\n          this.emit('error', error, execution, funcDetails, finalPayload)\n          reject(error)\n        }\n      )\n\n      this.emit('start', execution, payload)\n      executeTree(\n        execution,\n        payload,\n        this.executeBranchWrapper,\n        (funcDetails, path, currentPayload) => {\n          this.emit('pathStart', path, execution, funcDetails, currentPayload)\n        },\n        (currentPayload) => {\n          this.emit('pathEnd', execution, currentPayload)\n        },\n        (currentPayload, functionsToResolve) => {\n          this.emit(\n            'parallelStart',\n            execution,\n            currentPayload,\n            functionsToResolve\n          )\n        },\n        (currentPayload, functionsResolved) => {\n          this.emit(\n            'parallelProgress',\n            execution,\n            currentPayload,\n            functionsResolved\n          )\n        },\n        (currentPayload, functionsResolved) => {\n          this.emit('parallelEnd', execution, currentPayload, functionsResolved)\n        },\n        (finalPayload) => {\n          this.emit('end', execution, finalPayload)\n          resolve === reject\n            ? resolve(null, finalPayload)\n            : resolve(finalPayload)\n        }\n      )\n    }\n\n    if (cb) {\n      withResolveAndReject(cb, cb)\n    } else {\n      return new Promise(withResolveAndReject)\n    }\n  }\n}\n"]}