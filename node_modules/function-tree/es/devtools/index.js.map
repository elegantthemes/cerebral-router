{"version":3,"sources":["../../src/devtools/index.js"],"names":["Provider","DevtoolsBase","WebSocket","default","Devtools","options","trees","latestExecutionId","version","init","ws","https","host","event","message","JSON","parse","data","type","sendInitial","tree","push","contextProviders","debugger","watchExecution","splice","indexOf","removeAllListeners","reduce","newTrees","forEach","remove","stringify","source","sendMessage","backlog","length","sendBulkMessage","isConnected","debuggingData","execution","functionDetails","payload","executionId","id","functionIndex","datetime","safeStringify","sendExecutionData","bind","send","context","props","wrapProvider","name","provider","Object","keys","wrappedProvider","key","originalFunc","args","method","apply","wrap"],"mappings":"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","file":"index.js","sourcesContent":["/* global VERSION */\nimport Provider from '../Provider'\nimport DevtoolsBase from './base'\nimport WebSocket from 'universal-websocket-client'\n\n// Used by cerebral/devtools\nexport { default as DevtoolsBase } from './base'\n\nexport class Devtools extends DevtoolsBase {\n  constructor(options) {\n    super(options)\n    this.trees = []\n    this.latestExecutionId = null\n    this.version = VERSION\n    this.init()\n  }\n  createSocket() {\n    this.ws = new WebSocket(`${this.https ? 'wss' : 'ws'}://${this.host}`)\n  }\n  onMessage(event) {\n    const message = JSON.parse(event.data)\n    switch (message.type) {\n      case 'pong':\n        this.sendInitial()\n        break\n      case 'ping':\n        this.sendInitial()\n        break\n    }\n  }\n  add(tree) {\n    this.trees.push(tree)\n    tree.contextProviders.debugger = this.Provider()\n    this.watchExecution(tree, 'ft')\n  }\n  remove(tree) {\n    this.trees.splice(this.trees.indexOf(tree), 1)\n    delete tree.contextProviders.debugger\n\n    tree.removeAllListeners('start')\n    tree.removeAllListeners('end')\n    tree.removeAllListeners('pathStart')\n    tree.removeAllListeners('functionStart')\n    tree.removeAllListeners('functionEnd')\n    tree.removeAllListeners('error')\n  }\n  removeAll() {\n    const trees = this.trees.reduce((newTrees, tree) => {\n      newTrees.push(tree)\n      return newTrees\n    }, [])\n    trees.forEach((tree) => {\n      this.remove(tree)\n    })\n  }\n  sendInitial() {\n    const message = JSON.stringify({\n      type: 'init',\n      source: 'ft',\n      version: this.version,\n    })\n\n    this.sendMessage(message)\n    if (this.backlog.length) {\n      this.sendBulkMessage(this.backlog, 'ft')\n      this.backlog = []\n    }\n    this.isConnected = true\n  }\n  /*\n    Create the stringified message for the debugger. As we need to\n    store mutations with the default true \"storeMutations\" option used\n    by time travel and jumping between Cerebral apps, we are careful\n    not doing unnecessary stringifying.\n  */\n  createExecutionMessage(debuggingData, execution, functionDetails, payload) {\n    const type = 'execution'\n    const data = {\n      execution: {\n        executionId: execution.id,\n        functionIndex: functionDetails.functionIndex,\n        payload: payload,\n        datetime: execution.datetime,\n        data: debuggingData,\n      },\n    }\n\n    return this.safeStringify({\n      type: type,\n      source: 'ft',\n      version: this.version,\n      data: data,\n    })\n  }\n  Provider() {\n    const sendExecutionData = this.sendExecutionData.bind(this)\n\n    return new Provider(\n      {\n        send(data) {\n          sendExecutionData(\n            data,\n            this.context.execution,\n            this.context.functionDetails,\n            this.context.props\n          )\n        },\n        wrapProvider(name, provider) {\n          return Object.keys(provider).reduce((wrappedProvider, key) => {\n            const originalFunc = provider[key]\n\n            wrappedProvider[key] = (...args) => {\n              this.context.debugger.send({\n                method: `${name}.${key}`,\n                args: args,\n              })\n\n              return originalFunc.apply(provider, args)\n            }\n\n            return wrappedProvider\n          }, {})\n        },\n      },\n      {\n        wrap: false,\n      }\n    )\n  }\n}\n\nexport default Devtools\n"]}